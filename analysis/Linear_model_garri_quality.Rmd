---
title: "Garri Functional Quality"
output: pdf_document
date: "2023-02-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Check that I have the packages}
packages_used <- c("tidyverse", "ggplot2", "here", "stringr" , "sommer","lme4","metan")
ip <- installed.packages()
all_packages_installed <- TRUE
for (package in packages_used){
  if (!(package %in% ip[,"Package"])){
    print(paste("Please install package", package))
    all_packages_installed <- FALSE
  }
}#END packages_used
if (!all_packages_installed) stop("Need to install packages")
```

```{r Use here package}
require(here)
here::i_am("analysis/Linear_model_garri_quality.Rmd")
```

```{r Pull in the data}
library(tidyverse)
Oto_22_func <- read.csv(here::here("data", "OTOBI_2022PYT_FUNCTIONAL.csv"), head=T)

# Oto_22_func<-read.csv("/Users/ca384/Documents/ChinedoziRepo/GarriQuality/data/OTOBI_2022PYT_FUNCTIONAL.csv", head=T) # data for Otobi wit swelling power, swelling indx, bulk denSIty and water absorbing capacity for 2022
Umu_22_func <- read.csv(here::here("data/UMU_2022_PYT_FUNCTIONAL.csv"), head=T)
# Umu_22_func<-read.csv("/Users/ca384/Documents/ChinedoziRepo/GarriQuality/data/UMU_2022_PYT_FUNCTIONAL.csv",head=T)# data for Umudike wit swelling power, swelling index, bulk denSIty and water absorbing capacity for 2022

str(Oto_22_func)
str(Umu_22_func)
Oto_22_func$Genotype<-as.factor(Oto_22_func$Genotype)
Oto_22_func$wac.<-as.numeric(Oto_22_func$wac.)
Umu_22_func$Genotype<-as.factor(Umu_22_func$Genotype)
head(Umu_22_func)
head(Oto_22_func)
str(Oto_22_func)
str(Umu_22_func)
summary(Oto_22_func)
summary(Umu_22_func)
```

```{r creating plots}
boxplot(Oto_22_func$wac. , main="Water absorbing capacity of garri OTO",ylab = "WAC",xlab="Genotypes")

boxplot(Umu_22_func$wac. , main="Water absorbing capacity of garri UMU",ylab="WAC", xlab="Genotypes") #Removing outliers using the boxplot method

library(ggplot2)

par(mfrow=c(2,2))
boxplot(Oto_22_func$swelling.index, xlab="Genotypes", ylab="SI")
boxplot(Oto_22_func$swelling.power, ylab="SP",xlab="Genotypes")
boxplot(Oto_22_func$wac.,ylab="WAC", xlab="Genotypes")
boxplot(Oto_22_func$Bulk.Density, xlab="Genotypes", ylab="Bulk density")

```



```{r rename a column and adding new colun for otobi and umudike}
library("dplyr") #Using rename()

colnames(Oto_22_func)
colnames(Umu_22_func)
Umu_22_func <- Umu_22_func %>% 
       rename(Bulk.Density = AverageBD) # rename bulk density

Umu_22_func <- Umu_22_func %>% 
       rename(WAC= wac.) # rename wac. to WAC
Umu_22_func <- Umu_22_func %>% 
       rename(swelling.index= Swelling.index) # rename wac. to WAC



Oto_22_func <- Oto_22_func %>% 
       rename(WAC= wac.) # rename wac. to WAC for otobi
```

```{r remove column sn and add column for year and location}
library(tidyverse)
Umu_22_func <-Umu_22_func %>%
  add_column(location = "Umudike", year="2022") # add column with location and year for Umudike
head(Umu_22_func)
Umu_22_func <- subset(Umu_22_func, select=-c(sn)) # Remove the sn
head(Umu_22_func)
Umu_22_func <- Umu_22_func %>% relocate(location, year) # change the poSItion of the location and year

Oto_22_func <- Oto_22_func %>%
  add_column(location = "Otobi", year="2022") %>% relocate(location, year)
# change the poSItion of location and year from last column to the first column
```


```{r joining the two data frame}
Umu_oto_22 <- rbind(Oto_22_func, y=Umu_22_func)

str(Umu_oto_22)
Umu_oto_22$location <- as.factor(Umu_oto_22$location)
Umu_oto_22$year <- as.factor(Umu_oto_22$year)
str(Umu_oto_22)
glimpse(Umu_oto_22)
summary(Umu_oto_22)
plot(Umu_oto_22)
colnames(Umu_oto_22)
```

```{r importing 2019 functional properties data and renaming column}
Oto_19 <- read.csv(here::here("data", "functional-otobi2019_2020.csv"), head=T)

Umu_19 <- read.csv(here::here("data", "Umu_func_pyt2019_2020.csv"), head=T)

str(Oto_19)
str(Umu_19)

colnames(Oto_19)
colnames(Umu_19)

Oto_19 <- Oto_19 %>% 
       rename(Genotype= sample_id)

Umu_19 <- Umu_19 %>% 
       rename(Genotype= Genotypes)

Umu_19 <- Umu_19 %>% 
       rename(Moisture = X.moisture)

Umu_19 <- Umu_19 %>% 
       rename(Dry.Matter =X..Dry.Matter)

Oto_19 <- Oto_19 %>% 
       rename(swelling.index=Swelling.Index..final.initial.)

Oto_19 <- Oto_19 %>% 
       rename(swelling.power= SP)

Oto_19 <- Oto_19 %>% 
       rename(Bulk.Density= Bulk.Density..g.ml.)

colnames(Oto_19)
colnames(Umu_19)
dim(Oto_19)
str(Oto_19)
dim(Umu_19)



```

```{r select the need column from Oto_19 and Umu_19, Add year 2019, change the stucture of the data}

 #selecting  column

Oto_Selected <- Oto_19 %>% dplyr::select("location", "Genotype" ,"swelling.index", "swelling.power", "WAC"          , "Bulk.Density" )


#taking the average of the genotypes duplicates for otobi
Oto_Selected_aggre <- Oto_Selected %>% group_by(Genotype) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

str(Oto_Selected_aggre)


Oto_Selected_aggre$Genotype <- as.factor(Oto_Selected_aggre$Genotype)

#Add columns for years and location
Oto_Selected_aggre  <-  Oto_Selected_aggre  %>%
  add_column(location = "Otobi",year = "2020") # change the year from 2019 to 2020
 


Umu_Selected <- Umu_19 %>% dplyr:: select('Genotype', 'swelling.index', 'swelling.power', 'WAC', 'Bulk.Density') # select the needed columns
 
Umu_Selected  <-  Umu_Selected  %>%
  add_column(location = "Umudike",year = "2020") # add location and year to the data frame


#add otobi and umudike 2019 data 
Umu_oto_19 <- rbind(Oto_Selected_aggre,Umu_Selected)
str(Umu_oto_19)
Umu_oto_19$location <-  as.factor(Umu_oto_19$location)
Umu_oto_19$year <-  as.factor(Umu_oto_19$year)
Umu_oto_19 <- data.frame(Umu_oto_19 )
Umu_oto_19 <-  Umu_oto_19  %>% relocate(location, year) # change the positions of year and location
```

```{r read in the dosage file and modify the row names to match with that in the phenotypic file}

snps_dosage <- read.csv(here::here("data/snps_199_genotype.csv"), head=T)

genotype_snps <- snps_dosage$X # get the genotype names from the snp dosage file to make it look like the names on the phenotype file

write.csv(genotype_snps,file=here("genotype_snps.csv")) # Had genotype names in new order (NR17C2aF10P011)

geno_snps <- read.csv(here::here("data/genotype_snps.csv"), head=T)  # had genotype names in old order eg (NR17F10C2aP011)


#snps_dosage_N <- sub('IITA.TMS.','IITA-TMS-',geno_snps$X) # To ma sure all the genotypes names are correct . Rewrite the checks

 # combine snps_dosage_N with the dosage file

geno_name <- data.frame(geno_snps) # with genotype name in correct order

new_snp <- cbind(geno_name,snps_dosage) # Combine the new and old order genotype names in one data frame.

new_snp_names <- (new_snp[-2]) #Deselect the column with the old names

#ew_snp_data <- new_snp_names %>% 
       #rename("X" = "snps_dosage_N") #change the column name of the genotypes back to X

dim(new_snp_names)
```

```{r read in 2020_2021 data for Otobi and Umudike}
Umu_21 <- read.csv(here::here("data", "Umu_2020_2021_PYT_Functional.csv"), head=T) # input genotypes planted in 2020 and harvested in 2021

Oto_21 <- read.csv(here::here("data", "OTOBI_2020_2021_PYT_Functional.csv"), head=T)

str(Umu_21)
dim(Umu_21)
Umu_21$Genotypes <- as.factor(Umu_21$Genotypes)
Umu_21 <- Umu_21 %>% 
       rename(Genotype= Genotypes) # rename Genotypes to genotype
Umu_21 <- Umu_21 %>% 
       rename(swelling.index= Swelling.index)

Umu_21$WAC <- as.numeric(Umu_21$WAC)
str(Oto_21)
Oto_21$Genotype <- as.factor(Oto_21$Genotype)
dim(Oto_21)
```

```{r combining 2021 Umudike and otobi in one data frame and adding year and location}

Umu_21  <-  Umu_21  %>%
  add_column(location = "Umudike",year = "2021") # add year and location to Umu_21
Oto_21  <-  Oto_21  %>%
  add_column(location = "Otobi",year = "2021") # add year and location to oto_21

 Umu_oto_21 <- rbind(Oto_21, Umu_21)# combining the two data frame

 Umu_oto_21 <-  Umu_oto_21 %>% relocate(location, year) # change the poSItion of year and location
 
```

```{r combining all three years}
pyt_functional <- rbind(Umu_oto_19, Umu_oto_21, Umu_oto_22) # combine all three years
dim(pyt_functional)
pyt_functional = as.data.frame(pyt_functional)
```


```{r using  concanate year and location to be a column called environment}
# create a new column that has Environment to make it look like the data frame in sommer example
#rm(pyt_functional_1)
pyt_functional_1 <- pyt_functional %>%
unite( 'environment', location:year, sep= "_", remove = FALSE) # concantenating location and environment
summary(pyt_functional_1$Genotype)


#summary(wac_model)$varcomp
# pyt_functional_1$environment = gsub(pattern = " ",replacement = "_", x = pyt_functional_1$environment)
#pyt_functional_1$environment = as.factor(pyt_functional_1$environment)
#head(pyt_functional_1)
```


```{r editing genotype names in pyt_functional_1$Genotype to match with snp$X and uSIng metan package to change multiple column as factor}

head(pyt_functional_1)

levels(pyt_functional_1$Genotype)[levels(pyt_functional_1$Genotype) =="TME419"] = "TMEB419" # changing genotype name pattern

levels(pyt_functional_1$Genotype)[levels(pyt_functional_1$Genotype) =="IITA-TMS-1BA30572" ] = "IITA-TMS-IBA30572" # changing genotype name pattern
pyt_functional_1$Genotype = gsub(pattern = " ", replacement = "", x = pyt_functional_1$Genotype) # remove space from the genotype name 



pyt_functional_1 <-  as.data.frame(pyt_functional_1)
pyt_functional_1 <- as_factor(.data = pyt_functional_1, 
                c("environment","location","year","Genotype"))
str(pyt_functional_1)

length(levels(pyt_functional_1$Genotype))
#exm = as_numeric(.data = pyt_functional_1, c("swelling.index","swelling.power","WAC","Bulk.DensIty"))
#str(exm)

write.csv(x = pyt_functional_1$Genotype, file = "pyt_functional_all_years.csv")

```


```{r boxplot using the large data frame }
str(pyt_functional_1)
boxplot
ggplot(data = pyt_functional_1,aes(x=year,y= swelling.index,fill=location)) +
  geom_boxplot() + facet_grid(.~location)

ggplot(data = pyt_functional_1,aes(x=year,y= swelling.power,fill=location)) +
  geom_boxplot()+facet_grid(.~location)

ggplot(data = pyt_functional_1,aes(x=year,y= WAC,fill=location))+
  geom_boxplot()+facet_grid(.~location)

ggplot(data = pyt_functional_1,aes(x=year,y= Bulk.Density,fill=location))+
  geom_boxplot()+facet_grid(.~location)


```


```{r removing outliers for swelling index}
quartiles_SI <- quantile(pyt_functional_1$swelling.index, probs=c(.25, .75), na.rm = TRUE) # qualtile for swelling index
IQR_SI <- IQR(pyt_functional_1$swelling.index, na.rm = TRUE) # interquatile range  
 
Lower_SI <- quartiles_SI[1] - 1.5*IQR_SI
Upper_SI <- quartiles_SI[2] + 1.5*IQR_SI
 
data_no_outlier_SI <- subset(pyt_functional_1, pyt_functional_1$swelling.index > Lower_SI & pyt_functional_1$swelling.index < Upper_SI)
 
dim(data_no_outlier_SI)


ggplot(data = data_no_outlier_SI,aes(x=year,y= swelling.index,fill=location)) +
  geom_boxplot() + facet_grid(.~location)

```

```{r remove outlier for bulk density}
quartiles_WAC <- quantile(pyt_functional_1$WAC, probs=c(.25, .75), na.rm = TRUE) # qualtile for swelling index
IQR_WAC <- IQR(pyt_functional_1$WAC, na.rm = TRUE) # interquatile range  
 
Lower_WAC <- quartiles_WAC[1] - 1.5*IQR_WAC
Upper_WAC <- quartiles_WAC[2] + 1.5*IQR_WAC
 
data_no_outlier_WAC <- subset(pyt_functional_1, pyt_functional_1$WAC > Lower_WAC & pyt_functional_1$WAC < Upper_WAC)
 
dim(data_no_outlier_WAC)
View(data_no_outlier_WAC)

ggplot(data = data_no_outlier_WAC,aes(x=year,y= WAC,fill=location)) +
  geom_boxplot() + facet_grid(.~location)
ggplot(data = pyt_functional_1,aes(x=year,y= WAC,fill=location))+
  geom_boxplot()+facet_grid(.~location)

```





```{r extract each year to get the year information}
oto20  <- droplevels(pyt_functional_1[pyt_functional_1$environment == "Otobi_2020",])
oto21  <- droplevels(pyt_functional_1[pyt_functional_1$environment == "Otobi_2021",])
oto22  <- droplevels(pyt_functional_1[pyt_functional_1$environment == "Otobi_2022",])
 
summary(oto20)
summary(oto21)
summary(oto22)

Umu20  <- droplevels(pyt_functional_1[pyt_functional_1$environment == "Umudike_2020",])
Umu21  <- droplevels(pyt_functional_1[pyt_functional_1$environment == "Umudike_2021",])
Umu22  <- droplevels(pyt_functional_1[pyt_functional_1$environment == "Umudike_2022",])

summary(Umu20)
summary(Umu21)
summary(Umu22)

```


```{r run linear models for wac}
dat1 <- droplevels(pyt_functional_1[!is.na(pyt_functional_1$WAC),])
dim(pyt_functional_1)
dim(dat1)

lm <- lm(formula = WAC ~ Genotype + year + location + year:location + Genotype:location, data = dat1)

lm2 <- lm(formula = WAC ~ Genotype + year + location + year:location + Genotype:location + Genotype:year,
     data = dat1)
# the data i removed outliers
data_no_outlier_WAC <- data.frame(data_no_outlier_WAC)

anova(lm)
anova(lm2)


anova(lm)

## variance componenet
library(lme4)
lmr_wac <- lmer(formula = WAC ~ (1|Genotype) + (1|year) +  (1|year:location) + (1|Genotype:year), data = dat1)
summary(lmr_wac)
plot(lmr_wac)
# to calculate heritability
ss <- summary(lmr_wac) 
sv <- as.data.frame(ss$varcor) # get the variance component
gv <- sv[sv$grp=="Genotype", "vcov"] # genetic variance
#gl <- sv[sv$grp == "Genotype:location" , "vcov"] # genotype by location variance
gy <- sv[sv$grp == "Genotype:year" , "vcov"] # genotype by year variance 
ev <- sv[sv$grp == "Residual" , "vcov"] # reSIdual variance
vph <- gv + gy/3 + ev/3 # variance due to phenotype
Hb_wac <- gv/vph 
print(Hb_wac)


lmr_wac_a <- lmer(formula = WAC ~ (1|Genotype) + (1|year) + (1|location) + (1|year:location) + (1|Genotype:location) , data = data_no_outlier_WAC)
summary(lmr_wac_a)

# to calculate heritability
ss_a <- summary(lmr_wac_a) 
sv_a <- as.data.frame(ss$varcor) # get the variance component
gv_a <- sv_a[sv_a$grp=="Genotype", "vcov"] # genetic variance
#gl_a <- sv_a[sv_a$grp == "Genotype:location" , "vcov"] # genotype by location variance
gy_a <- sv_a[sv_a$grp == "Genotype:year" , "vcov"] # genotype by year variance 
ev_a <- sv_a[sv_a$grp == "ReSIdual" , "vcov"] # reSIdual variance
vph_a <- gv_a  + gy/3 + ev/3 # variance due to phenotype
Hb_wac_a <- gv_a/vph_a 
print(Hb_wac_a)
```



```{r use the genotypic data to see if the narrow sense heriability will be high ansubsetting the needed genotpic data}

new_geno_dat <- new_snp_names[new_snp_names %in% pyt_functional_1$Genotype]

dim(pyt_functional_1)

dim(new_geno_dat)

View(new_geno_dat)

head(new_geno_dat)

#new_geno_dat <- new_snp_names %>%
      #filter(X %in% pyt_functional_1$Genotype)


geno_absent<-new_snp_names[(!new_snp_names[,1] %in% rownames( pyt_functional_1)),1] #geno  not in row names of 
View(geno_absent)


snp_data <- print(new_snp_names[order(new_snp_names$X), ])
```

```{r}
uniqueName_geno<- unique(new_snp_names)
dim(uniqueName_geno)

uni<-unique(pyt_functional_1)
dim(uni)
dim(pyt_functional_1)

pheno_name=data.frame(pyt_functional_1$Genotype)
pheno_nam_list=as.list(pheno_name)
```

